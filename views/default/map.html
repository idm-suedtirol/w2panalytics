<main id="main-map">
             <div id="map"></div>
            <div class="map-panel">
                <h3 tkey="layer-map" id="title-sidebar-map">Layer mappa</h3>
                <ul>
                    <li><a href="#" class="icon icon-bluetooth" id="icon-bluetooth" onclick="load_geojson_bluetooth()"><span tkey="bluetooth-station">Stazioni Bluetooth</span></a></li>
                    <li><a href="#" class="icon icon-traffico" id="icon-traffico"><span tkey="traffic-station">Stazioni traffico</span></a></li>
                    <li><a href="#" class="icon icon-percorrenza" id="icon-percorrenza" onclick="load_tileLayer_l_congestion()"><span tkey="journey-time">Tempi percorrenza</span></a></li>
                    <li><a href="#" class="icon icon-parcheggi" id="icon-parcheggi" onclick="load_geojson()"><span tkey="parking">Parcheggi</span></a></li>
                    <li><a href="#" class="icon icon-meteo"><span tkey="weather">Meteo</a></li>
                    <li><a href="#" class="icon icon-inquinamento" id="icon-inquinamento" onclick="load_geojson_env()"><span tkey="stations-pollution">Stazioni inquinamento</span></a></li>
                    <li><a href="#" class="icon icon-inquinanti" id="icon-inquinanti"><span tkey="pollutant-dispersion">Dispersione inquinanti</span></a></li>
                    <li><a href="#" class="icon icon-pm10" id="icon-pm10" onclick="load_tileLayer_pm10()"><span tkey="pm10-emissions">Emissioni PM10</span></a></li>
                    <li><a href="#" class="icon icon-nox" id="icon-nox" onclick="load_tileLayer_l_nox()"><span tkey="nox-emissions">Emissioni NO<sub>x</sub></span></a></li>
                    <li><a href="#" class="icon icon-co2"><span tkey="co2-emissions">Emissioni CO<sub>2</sub></span></a></li>
                    <li><a href="#" class="icon icon-veicolo-sonda"><span tkey="probe-vehicle">Veicolo sonda</span></a></li>
                </ul>
                <a href="#" id="deselect-layers" tkey="uncheck-all" onclick="reset_map()">Deseleziona tutti</a>
            </div>
</main>
<script>
    var map = L.map('map').setView([46.493, 11.34], 14);
    var popup_selected;
    var geojsonLayer;
    var geojsonLayerBluetooth;
    var geojsonLayerEnv;
    var geojsonLayerParking;
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);
    $('div.leaflet-top').removeClass('leaflet-left').addClass('leaflet-right');
    var l_pm10 = L.tileLayer.betterWms("http://geodata.integreen-life.bz.it/geoserver/edi/wms", {
        layers: 'edi:pollution_pm10',
        transparent: true,
        attribution: "",
        format: 'image/png',
    });
    
    var l_nox = L.tileLayer.betterWms("http://geodata.integreen-life.bz.it/geoserver/edi/wms", {
        layers: 'edi:pollution_nox',
        transparent: true,
        attribution: "",
        format: 'image/png',
    });

    var l_congestion = L.tileLayer.betterWms("http://geodata.integreen-life.bz.it/geoserver/edi/wms", {
        layers: 'edi:congestion',
        transparent: true,
        attribution: "",
        format: 'image/png',
    });
    
    var l_vehicle = L.tileLayer.betterWms("http://geodata.integreen-life.bz.it/geoserver/edi/wms", {
        layers: 'edi:no2_1_microgm3_ma_position',
        transparent: true,
        attribution: "",
        format: 'image/png',
    });
    
    

    $(document).on('shown.bs.tab','body a[data-toggle="tab"]', function() { 
        map.invalidateSize(false);
    });

    function load_geojson() {
        setTimeout(function(){ 
            if($("#icon-parcheggi").hasClass( "active" )==true){

                var url = 'http://parking.bz.it/parkbzNew/default/get_geojson';
                var params = {url_base:true};
                var url_request = url + '?' + jQuery.param(params);
                $.getJSON(url_request, function( data ) {
                    geojsonLayerParking = L.geoJson(data, {
                        pointToLayer: function (feature, latlng) {
                            var freeslots = feature.properties.freeslots;
                            icon = ((freeslots > 70)? "green" : ((freeslots > 10) ? "yellow" : ((freeslots >= 0)? "red" : "grey")));
                            var markerIcon = new L.Icon.Default({
                                 iconUrl: "/vtraffic/static/js/images/marker-icon-" + icon + ".png",
                                    iconRetinaUrl: "/vtraffic/static/js/images/marker-icon-" + icon + "-2x.png",
                            });
                            return L.marker(latlng);
                        },
                        onEachFeature: onEachFeature
                    }).addTo(map);
                // Add the new layer to the layerControl
                });
           }else{
                map.removeLayer(geojsonLayerParking);
            }
        }, 1000);
    }

    function load_geojson_bluetooth() {
        setTimeout(function(){ 
               if($("#icon-bluetooth").hasClass( "active" )==true){
                   var url_request = '{{=URL('data', 'get_geojson', vars={'frontend':'Bluetooth', 'type':'Bluetooth Count record', 'period':1800})}}';
                    $.getJSON(url_request, function( data ) {
                    geojsonLayerBluetooth=L.geoJson(data, {
                        pointToLayer: function (feature, latlng) {
                            var v = feature.properties.last_value;
                            icon = ((v > 200)? "3" : ((v > 100) ? "2" : "1"));
                            var markerIcon = new L.Icon.Default({
                                iconUrl: '{{=URL('static','images/bluetooth-icon.png')}}',
                                iconRetinaUrl: '{{=URL('static','images/bluetooth-icon.png')}}',
                            });
                           
                            return L.marker(latlng, {icon: markerIcon});
                        },
                        onEachFeature: onEachFeatureBluetooth 
                    }).addTo(map);
                // Add the new layer to the layerControl
                    });
            }else{
                map.removeLayer(geojsonLayerBluetooth);
            }
        }, 1000);
    }

    function load_geojson_env() {
        setTimeout(function(){ 
            if($("#icon-inquinamento").hasClass( "active" )==true){    
                    var url_request = '{{=URL('data', 'get_geojson', vars={'frontend':'Environment', 'type':'NO2'})}}';
                    $.getJSON(url_request, function( data ) {
                        geojsonLayerEnv = L.geoJson(data, {
                            pointToLayer: function (feature, latlng) {
                                var v = feature.properties.last_value;
                                icon = ((v < 50)? "green" : ((v < 100) ? "yellow" : ((v < 200)? "red" : "grey")));
                                var markerIcon = new L.Icon.Default({
                                    iconUrl: '{{=URL('static','images/inquinamento-icon.png')}}',
                                    iconRetinaUrl: '{{=URL('static','images/inquinamento-icon.png')}}',
                                });
                                return L.marker(latlng, {icon: markerIcon});
                            },
                        onEachFeature: onEachFeatureEnv
                        }).addTo(map);
            // Add the new layer to the layerControl
                     });
            }
            else{
                map.removeLayer(geojsonLayerEnv);
            }
        }, 1000);
    }

    function load_tileLayer_pm10() {
        setTimeout(function(){
            if($("#icon-pm10").hasClass( "active" )==true){    
                l_pm10.addTo(map);
            }else{
                map.removeLayer(l_pm10);
            }
        }, 1000);
        
        
    }
    
    
     function load_tileLayer_l_nox() {
        setTimeout(function(){
            if($("#icon-nox").hasClass( "active" )==true){    
                l_nox.addTo(map);
            }else{
                map.removeLayer(l_nox);
            }
        }, 1000);    
    }
    
    
     function load_tileLayer_l_congestion() {
        setTimeout(function(){
            if($("#icon-percorrenza").hasClass( "active" )==true){    
                l_congestion.addTo(map);
            }else{
                map.removeLayer(l_congestion);
            }
        }, 1000);    
    }
    
    function load_tileLayer_l_vehicle() {
        setTimeout(function(){
            if($("#icon-traffico").hasClass( "active" )==true){    
                l_congestion.addTo(l_vehicle);
            }else{
                map.removeLayer(l_vehicle);
            }
        }, 1000);    
    }
    
    
    map.on("popupopen", function(e) {
        popup_open = e.popup;
        $('.carpark').trigger('reload', true);
    });
    map.on("popupclose", function() {
        popup_open = undefined;
    });
    
    load_geojson();

    function onEachFeatureBluetooth (feature, layer) {
        var popupContent;
        if (feature.properties && feature.properties.popupContent) {
            popupContent = feature.properties.popupContent;
        }
        var popup;
        var first_text;
        var second_text;
        var left_link;
        var right_link;
        var street=popupContent.replace('-', '');
        street=street.replace(/[0-9]/g, '');
        console.log('GUARDAAAA'+street);
        var tipology="Bluetooth";
        if(langCode=="it"){
            first_text="Rilevamenti";
            second_text="Negli ultimi 15 minuti"
            left_link="Trend ultima ora";
            right_link="Grafico storico";
        }else{
         if(langCode=="de"){
                first_text="Umfragen";
                second_text="In den letzten 15 Minuten"
                left_link="Trend der letzten Stunde";
                right_link="History Graphen";
         }
         else{
             first_text="Data detect";
             second_text="In the last 15 minutes"
             left_link="Trend last hours";
             right_link="Storic graph";
         }
            
        }
           popup = layer.bindPopup("<div style='margin-bottom:10px'><h1 style='font-weight: bold;font-size: 30px;'>TIS Innovation Park</h1></div><div class='container-fluid' style='background:#315cab;margin-bottom:10px'><div class='row-fluid'><div class='col-md-3' style='color:white;padding-top:8px;padding-bottom:8px;'><h1 style='font-weight: bold;font-size: 45px;'>36</h1></div><div class='col-md-9' style='color:white;padding-top:8px;padding-bottom:8px;'><h1 style='font-weight: bold;font-size: 15px;'>"+first_text+"<br/>"+popupContent+"<br/>"+second_text+"</h1></div></div></div><div class='container-fluid' style='margin-bottom:10px;background:white'><div class='row-fluid'><div class='col-md-6' style='padding-top:4px;padding-bottom:4px;'><a href='#' onclick='graphTrend(\""+tipology+"\",\""+street+"\")' style='color:#315cab;border-bottom:2px dashed #d5d5d5;border-color:#315cab'>"+left_link+"</a></div><div class='col-md-6' style='padding-top:4px;padding-bottom:4px;'><a  onclick='graphStoric(\""+tipology+"\",\""+street+"\")' href='#' style='color:#315cab;border-bottom:2px dashed #d5d5d5;border-color:#315cab;'><span style='margin-right:2px'>"+right_link+"</span><i class='glyphicon glyphicon-edit' style='color:#315cab;'/></a></div>");
      
        if (feature.properties && feature.properties.openPopup) {
            popup_selected = popup;
        }
    }
    
    
    function onEachFeatureEnv (feature, layer) {
        var popupContent;
        if (feature.properties && feature.properties.popupContent) {
            popupContent = feature.properties.popupContent;
        }
        var popup;
        var first_text;
        var second_text;
        var left_link;
        var right_link;
        var street=popupContent;
        street=(street.split(" "));
        street=street[0];
        var tipology="Environment";
        if(langCode=="it"){
            first_text="Concentrazione NO2";
            second_text="Dato attuale"
            left_link="Trend ultima ora";
            right_link="Grafico storico";
        }else{
         if(langCode=="de"){
                first_text="Konzentration NO2";
                second_text="Gegebenen Strom"
                left_link="Trend der letzten Stunde";
                right_link="History Graphen";
         }
         else{
             first_text="Concentration";
             second_text="Actual date"
             left_link="Trend last hours";
             right_link="Storic graph";
         }
            
        }
        
        
        
        popup = layer.bindPopup("<div><h1 style='font-weight: bold;font-size: 30px;'>TIS Innovation Park</h1></div><div class='container-fluid' style='background:#ffa927;margin-bottom:10px'><div class='row-fluid'><div class='col-md-3' style='color:white;padding-top:8px;padding-bottom:8px;'><h1 style='font-weight: bold;font-size: 45px;'>53</h1><h1 style='font-weight: bold;font-size: 15px;'>g/km/h</h1></div><div class='col-md-9' style='color:white;padding-top:8px;padding-bottom:8px;'><h1 style='font-weight: bold;font-size: 15px;'>"+first_text+"<br/>"+popupContent+"<br/>"+second_text+"</h1></div></div></div><div class='container-fluid' style='margin-bottom:10px;background:white'><div class='row-fluid'><div class='col-md-6' style='padding-top:4px;padding-bottom:4px;'><a href='#' onclick='graphTrend(\""+tipology+"\",\""+street+"\")' style='color:#93208c;border-bottom:2px dashed #d5d5d5;border-color:#93208c'>"+left_link+"</a></div><div class='col-md-6' style='padding-top:4px;padding-bottom:4px;'><a href='#' onclick='graphStoric(\""+tipology+"\",\""+street+"\")' style='color:#93208c;border-bottom:2px dashed #d5d5d5;border-color:#93208c;'><span style='margin-right:2px'>"+right_link+"</span><i class='glyphicon glyphicon-edit' style='color:#93208c;'/></a></div>");
        if (feature.properties && feature.properties.openPopup) {
            popup_selected = popup;
        }
    }
    
    function onEachFeature (feature, layer) {
        var popupContent;
        if (feature.properties && feature.properties.popupContent) {
            popupContent = feature.properties.popupContent;
        }
        var popup = layer.bindPopup("<div style='margin-bottom:10px'><h1 style='font-weight: bold;font-size: 30px;'>TIS Innovation Park</h1></div><div class='container-fluid' style='background:#ffa927;margin-bottom:10px'><div class='row-fluid'><div class='col-md-3' style='color:white;padding-top:4px;padding-bottom:4px;'><h1 style='font-weight: bold;font-size: 45px;'>53</h1></div><div class='col-md-9' style='color:white;padding-top:4px;padding-bottom:4px;'><h1 style='font-weight: bold;font-size: 15px;'>Concentrazione NO2<br/>"+popupContent+"<br/>Negli ultimi 15 minuti</h1></div></div></div><div class='container-fluid' style='margin-bottom:10px;background:white'><div class='row-fluid'><div class='col-md-6' style='padding-top:4px;padding-bottom:4px;'><a href='#' style='color:#93208c;border-bottom:2px dashed #d5d5d5;border-color:#93208c'>Trend ultima ora</a></div><div class='col-md-6' style='padding-top:4px;padding-bottom:4px;'><a href='#' style='color:#93208c;border-bottom:2px dashed #d5d5d5;border-color:#93208c;'><span style='margin-right:2px'>Grafico storico</span><i class='glyphicon glyphicon-edit' style='color:#93208c;'/></a></div>");
        if (feature.properties && feature.properties.openPopup) {
            popup_selected = popup;
        }
    }
    $(document).on('click', '.forecast h3', function(){
        var el = $(this);
	    $(this).toggleClass('open').next().slideToggle('fast', function() {
	        $(el).trigger('slidend');
	    });
    });
    
    function reset_map(){
        if($("#icon-parcheggi").hasClass( "active" )==true){                
            map.removeLayer(geojsonLayerParking);
        }
        if($("#icon-bluetooth").hasClass( "active" )==true){                
            map.removeLayer(geojsonLayerBluetooth);
        }
        if($("#icon-inquinamento").hasClass( "active" )==true){    
            map.removeLayer(geojsonLayerEnv);
        }
        if($("#icon-pm10").hasClass( "active" )==true){    
            map.removeLayer(l_pm10);
        }
        if($("#icon-nox").hasClass( "active" )==true){    
            map.removeLayer(l_nox);
        }
        if($("#icon-percorrenza").hasClass( "active" )==true){    
            map.removeLayer(l_congestion);
        }
        if($("#icon-traffico").hasClass( "active" )==true){    
            map.removeLayer(l_vehicle);
        }

    }
    
    function graphTrend(tipology,street){
         if ( $('#sidebar_grafici').children().length > 0 ) {
             
           plot_console.data = [];
           plot_console.datasets = []
           plot_console.plotAccordingToChoices();
           if(langCode=="it"){
                $("#frontends_form #select2-select_frontend-container").html("Seleziona tipologia");
                $("#select2-form-control_stations-container").html("Seleziona sorgente");
                $( "select.form-control_frontends" ).val("Seleziona tipologia");
                $( "select.form-control_stations" ).val("Seleziona sorgente");
            }
            else{
                if(langCode=="de"){
                    $("#frontends_form #select2-select_frontend-container").html("Typ auswählen"); 
                    $("#select2-form-control_stations-container").html("Quelle wählen");
                    $( "select.form-control_frontends" ).val("Typ auswählen");
                    $( "select.form-control_stations" ).val("Quelle wählen");
                 
                }else{
                    $("#frontends_form #select2-select_frontend-container").html("Select tipology");
                    $("#select2-form-control_stations-container").html("Select source");
                    $( "select.form-control_frontends" ).val("Select tipology");
                    $( "select.form-control_stations" ).val("Select source");
                }


             }
         }
           
        var select_street;
        $('#select2-select_frontend-container').text(tipology);
        $( "select.form-control_frontends" ).val(tipology);
        changeTipology();
        setTimeout(function(){
               $("#select2-form-control_stations-container").text(street);
               street=street.replace(/\s/g, '');
               $("#form-control_stations option").filter(function() {
                   select_street=this.text;
                   select_street=select_street.replace(/\s/g, '');
                   if(select_street==street){
                       $( "select.form-control_stations" ).val($(this).attr("value"));
                       street=$(this).attr("value");
                   }
               });
      
              
        }, 1000);
        setTimeout(function(){
                 changeSource();

        }, 1000);
         setTimeout(function(){
             $("a[data-station="+street+"]").trigger("click");
        }, 6000);
        setTimeout(function(){             
               date_set(moment().subtract(1,'hours'),moment());
        }, 8000);

        $('#myTab a:first').tab('show');   
 

    }
    
    function graphStoric(tipology,street){
        var select_street;
        $('#select2-select_frontend-container').text(tipology);
        $( "select.form-control_frontends" ).val(tipology);
        changeTipology();
        setTimeout(function(){
               $("#select2-form-control_stations-container").text(street);
               street=street.replace(/\s/g, '');
               $("#form-control_stations option").filter(function() {
                   select_street=this.text;
                   select_street=select_street.replace(/\s/g, '');
                   if(select_street==street){
                       $( "select.form-control_stations" ).val($(this).attr("value"));
                       street=$(this).attr("value");
                   }
               });
      
              
        }, 1000);
        setTimeout(function(){
                 changeSource();

        }, 1000);
         setTimeout(function(){
             $("a[data-station="+street+"]").trigger("click");
        }, 6000);

        $('#myTab a:first').tab('show');   
  
    }
</script>
